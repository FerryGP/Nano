<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>咒语魔盒 (Prompt Fill Tool) V0.6.0</title>
<style>
    /* --- 核心变量 --- */
    :root {
        --primary: #4f46e5;
        --primary-bg: #eef2ff;
        --border: #e5e7eb;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --bg-body: #f9fafb;
        --bg-white: #ffffff;
        --danger: #ef4444;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* --- 布局框架 --- */
    .app-container { display: flex; flex: 1; overflow: hidden; position: relative; }
    
    /* 1. 左侧：模版列表 (PC常驻, 移动端作为 Tab1) */
    .sidebar { width: 300px; background: var(--bg-white); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }
    
    /* 2. 右侧/主区域 */
    .main-viewport { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); position: relative; overflow: hidden; }
    
    /* 视图容器 (用于切换 Config 和 Editor) */
    .view-container { flex: 1; display: none; flex-direction: column; overflow: hidden; height: 100%; }
    .view-container.active { display: flex; }

    /* --- 通用组件 --- */
    button { cursor: pointer; border: none; background: none; outline: none; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    button:active { transform: scale(0.96); }
    
    .btn-primary { background: var(--primary); color: white; padding: 12px; border-radius: 8px; font-weight: 500; width: 100%; font-size: 14px; gap: 6px; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
    .btn-primary:hover { opacity: 0.9; }
    
    .btn-icon { color: #9ca3af; padding: 6px; border-radius: 6px; }
    .btn-icon:hover { background: #f3f4f6; color: var(--text-main); }
    .btn-icon.danger:hover { background: #fee2e2; color: var(--danger); }

    .scroll-y { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .scroll-y::-webkit-scrollbar { width: 4px; }
    .scroll-y::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }

    /* --- 模版列表项 (复刻 IMG_2944) --- */
    .template-item { padding: 16px; margin: 12px 16px; background: var(--bg-white); border-radius: var(--radius); cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .template-item:hover { box-shadow: var(--shadow); }
    
    /* 选中状态 */
    .template-item.active { border: 1px solid #c7d2fe; background: var(--bg-white); box-shadow: 0 0 0 2px var(--primary-bg); position: relative; }
    .template-item.active::before { content: ''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 4px; background: var(--primary); border-radius: 0 4px 4px 0; }
    
    .tpl-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .tpl-title { font-size: 15px; font-weight: 600; color: var(--text-main); }
    .tpl-actions { display: none; gap: 4px; }
    .template-item.active .tpl-actions { display: flex; }
    
    /* --- 词库配置视图 (复刻 IMG_2945) --- */
    .config-view { padding: 16px; background: var(--bg-body); }
    .config-group { margin-bottom: 24px; }
    .config-group-header { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .var-config-card { background: var(--bg-white); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
    .var-header { padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: var(--bg-white); }
    .var-header:hover { background: #f9fafb; }
    .var-name { font-size: 14px; font-weight: 600; color: var(--text-main); display: flex; flex-direction: column; }
    .var-key { font-size: 11px; color: var(--text-sub); font-family: monospace; margin-top: 2px; }
    
    .var-body { border-top: 1px solid #f3f4f6; padding: 0; display: none; background: #f9fafb; }
    .var-config-card.open .var-body { display: block; }
    
    .option-item { padding: 10px 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: white; }
    .option-item:last-child { border-bottom: none; }
    
    .add-option-row { padding: 8px 12px; display: flex; gap: 8px; background: #f3f4f6; border-top: 1px solid #e5e7eb; }
    .add-input { flex: 1; border: 1px solid #d1d5db; border-radius: 6px; padding: 6px 10px; font-size: 13px; outline: none; }
    .add-btn-small { background: var(--primary); color: white; border-radius: 6px; width: 32px; height: 32px; flex-shrink: 0; }

    /* --- Editor 视图 (复刻 IMG_2946) --- */
    .editor-layout { display: flex; height: 100%; flex-direction: column; }
    /* PC端横向分栏 */
    @media (min-width: 1024px) {
        .editor-layout { flex-direction: row; }
    }
    
    .editor-left { flex: 1; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-white); max-width: 100%; }
    @media (min-width: 1024px) { .editor-left { max-width: 450px; } }
    
    .editor-right { flex: 1; background: #f3f4f6; padding: 30px; overflow-y: auto; display: none; }
    @media (min-width: 1024px) { .editor-right { display: block; } }

    /* 输入框样式 */
    .field-card { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
    .field-label { font-size: 12px; font-weight: 600; color: #4b5563; margin-bottom: 6px; display: flex; justify-content: space-between; }
    .field-input-wrapper { position: relative; }
    .field-input { width: 100%; padding: 10px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; }
    .field-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-bg); }
    .field-dropdown-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 4px; color: #9ca3af; }

    /* 预览卡片 */
    .preview-paper { background: white; padding: 40px; min-height: 600px; box-shadow: var(--shadow); border-radius: 8px; font-family: monospace; font-size: 14px; line-height: 1.8; color: #374151; white-space: pre-wrap; }
    .hl { background: #e0e7ff; color: var(--primary); border-bottom: 2px solid var(--primary); padding: 0 4px; border-radius: 4px; font-weight: bold; }

    /* 底部导航 (Mobile) */
    .bottom-nav { height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #9ca3af; font-size: 10px; font-weight: 500; width: 100%; }
    .nav-item.active { color: var(--primary); }
    
    /* PC 顶部栏 */
    .pc-header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; background: white; }
    .pc-tabs { display: flex; gap: 4px; background: #f3f4f6; padding: 4px; border-radius: 8px; }
    .pc-tab { padding: 6px 16px; font-size: 13px; font-weight: 600; color: #6b7280; border-radius: 6px; }
    .pc-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    /* 响应式显示控制 */
    @media (min-width: 1024px) {
        .bottom-nav { display: none; }
        .sidebar { display: flex !important; } /* PC侧边栏常驻 */
        .view-template-mobile { display: none !important; } /* PC不显示模版管理的移动视图 */
    }
    @media (max-width: 1023px) {
        .sidebar { display: none; } /* 移动端侧边栏默认隐藏，内容由 Tab1 接管 */
        .pc-header { display: none; }
        .view-container { padding-bottom: 60px; }
        .main-viewport { flex: 1; }
    }
</style>
<!-- 引入 html2canvas 用于长图生成 -->
<script src="https://cdn.staticfile.net/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div class="app-container">
    
    <!-- 左侧侧边栏 (仅 PC 显示) -->
    <div class="sidebar pc-only-flex">
        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 18px; font-weight: 800; color: var(--primary);">咒语魔盒</div>
            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Prompt Fill Tool V0.6.0</div>
        </div>
        <div id="pc-template-list" class="scroll-y" style="padding: 10px 0;">
            <!-- 模版列表 (PC) -->
        </div>
        <div style="padding: 16px; border-top: 1px solid var(--border);">
            <button class="btn-primary" onclick="createNewTemplate()">+ 新建模版</button>
        </div>
    </div>

    <!-- 主视口 -->
    <div class="main-viewport">
        
        <!-- PC 顶部工具栏 (切换 Config/Editor) -->
        <div class="pc-header">
            <div class="pc-tabs">
                <button class="pc-tab active" onclick="switchTab('editor')" id="pc-tab-editor">Editor (填空)</button>
                <button class="pc-tab" onclick="switchTab('config')" id="pc-tab-config">词库配置</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-icon" onclick="exportImage()" title="保存图片">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                <button class="btn-primary" style="width: auto; padding: 8px 16px;" onclick="copyResult()">复制结果</button>
            </div>
        </div>

        <!-- 视图 1: 模版管理 (移动端 Tab 1) -->
        <div id="view-templates" class="view-container view-template-mobile">
            <div style="padding: 16px 20px; background: white; border-bottom: 1px solid var(--border);">
                <div style="font-size: 20px; font-weight: 800;">模版管理</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">切换或管理不同 Prompt</div>
            </div>
            <div id="mobile-template-list" class="scroll-y" style="background: #f9fafb;">
                <!-- 模版列表 (Mobile) -->
            </div>
            <div style="padding: 16px; background: white; border-top: 1px solid var(--border);">
                <button class="btn-primary" onclick="createNewTemplate()">+ 新建模版</button>
            </div>
        </div>

        <!-- 视图 2: 词库配置 (Config) -->
        <div id="view-config" class="view-container">
            <div style="padding: 16px 20px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 18px; font-weight: 800;">词库配置</div>
                    <div style="font-size: 11px; color: #9ca3af;">所有模版共享同一套词库</div>
                </div>
            </div>
            <div id="config-list" class="scroll-y config-view">
                <!-- 词库列表 -->
            </div>
        </div>

        <!-- 视图 3: Editor (填空) -->
        <div id="view-editor" class="view-container active">
            <div class="editor-layout">
                <!-- 左侧：输入区 -->
                <div class="editor-left">
                    <div style="padding: 16px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 700; font-size: 14px;" id="editor-title">未选择模版</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-icon" style="font-size: 12px;" onclick="switchMode()">切换源码/填空</button>
                        </div>
                    </div>
                    
                    <!-- 移动端预览条 -->
                    <div class="lg:hidden" style="padding: 12px; background: #eef2ff; border-bottom: 1px solid #e0e7ff; font-size: 12px; color: var(--primary); display: flex; justify-content: space-between; align-items: center;">
                        <span>实时预览中...</span>
                        <button style="font-weight: bold;" onclick="copyResult()">复制</button>
                    </div>

                    <div id="editor-inputs" class="scroll-y"></div>
                    
                    <!-- 源码模式编辑器 (默认隐藏) -->
                    <div id="code-editor" style="display: none; height: 100%; flex-direction: column;">
                        <input id="tpl-title-input" placeholder="模版标题" style="padding: 16px; border-bottom: 1px solid #eee; outline: none; font-weight: bold;">
                        <textarea id="tpl-content-input" style="flex: 1; padding: 16px; outline: none; border: none; resize: none; line-height: 1.6;" placeholder="在此输入 Prompt..."></textarea>
                    </div>
                </div>

                <!-- 右侧：PC 预览区 -->
                <div class="editor-right">
                    <div id="pc-preview" class="preview-paper"></div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- 底部导航栏 (Mobile) -->
<div class="bottom-nav">
    <div class="nav-item" onclick="switchTab('templates')" id="nav-templates">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        模版管理
    </div>
    <div class="nav-item active" onclick="switchTab('editor')" id="nav-editor">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        Editor
    </div>
    <div class="nav-item" onclick="switchTab('config')" id="nav-config">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
        词库配置
    </div>
</div>

<script>
// --- 数据层 ---
const DEFAULT_DATA = {
    templates: [
        { id: 't1', title: '角色概念分解图', content: "Role (角色设定)\n你是一位顶尖的 {{role}} ，擅长制作详尽的角色设定图。你具备“像素级拆解”的能力。\n\nTask (任务目标)\n生成一张“全景式角色深度概念分解图”。该图片必须包含 {{layout_focus}} ，并在其周围环绕展示该人物的服装分层、不同表情。\n\nVisual Guidelines:\n1. 构图: 中心位放置角色的 {{layout_focus}} 。\n2. 拆解内容:\n•服装分层: 例如： {{clothing}}\n•私密内着: 例如： {{underwear_style}}\n•表情集: 如： {{expressions}}\n•材质特写: 例如： {{texture_zoom}}\n\nStyle:\n•画风: {{art_style}}\n•灯光: {{lighting}}" },
        { id: 't2', title: '3x3 摄影网格', content: "创建一个 3x3 的摄影网格，展示 {{subject}} 的不同角度。\n风格: {{art_style}}\n光线: {{lighting}}\n每个格子应该展示: {{action_pose}}\n构图参考: {{camera_angle}}" },
        { id: 't3', title: '时尚情绪板插画', content: "Create a Fashion Moodboard Illustration for {{subject}}.\n\nElements:\n• Outfit: {{clothing}}\n• Deconstruction: {{fashion_deconstruct}}\n\nStyle:\n• Art: {{art_style}}\n• Bg: {{background_style}}\n• Items: {{bag_content}}" },
        { id: 't4', title: '人物趣味合影', content: "Draw a fun group photo featuring {{subject}} and {{character_companion}}.\n\nInteraction:\n• Pose: {{action_pose}}\n• Expressions: {{expressions}}\n• Toy: {{toy_companion}}\n\nScene:\n• Location: {{background_scene}}\n• Lighting: {{lighting}}" }
    ],
    options: {
        role: ["游戏概念设计师", "时尚摄影师", "电影导演", "人设画师"],
        subject: ["赛博朋克黑客", "森林精灵", "都市白领", "机甲驾驶员"],
        character_companion: ["一只肥猫", "童年的自己", "宿敌"],
        expressions: ["疯狂、病娇", "冷漠、无视", "羞涩、脸红"],
        grid_pose: ["站立、坐姿", "战斗姿态", "日常休闲"],
        action_detail: ["带着项圈爬行", "拔剑战斗", "优雅喝茶"],
        action_pose: ["背靠背战斗", "互相喂食", "摸头杀"],
        layout_focus: ["全身立绘", "半身像", "特写镜头"],
        camera_angle: ["平视", "低角度仰视", "高角度俯视"],
        connectors: ["手绘箭头", "虚线连接", "光效指引"],
        texture_zoom: ["皮革纹理", "金属锈迹", "丝绸光泽"],
        special_view: ["俯视", "仰视", "鱼眼镜头"],
        art_style: ["2D 插画", "吉卜力风格", "厚涂油画", "赛博霓虹"],
        background_style: ["漫画网格", "纯色极简", "赛博街道"],
        lens_param: ["85mm 人像", "35mm 广角"],
        lighting: ["自然光", "赛博霓虹", "伦勃朗光"],
        underwear_style: ["蕾丝内衣", "运动内衣", "棉质简约"],
        clothing: ["机能风外套", "丝绸长裙", "战斗装甲", "JK制服"],
        clothing_male: ["西装", "卫衣"],
        clothing_female: ["连衣裙", "短裙"],
        bag_content: ["口红与手机", "战术背包", "魔法药剂"],
        cosmetics: ["补妆镜", "急救包"],
        private_items: ["日记本", "怀表", "护身符"],
        fashion_deconstruct: ["面料色卡", "设计草图"],
        toy_companion: ["泰迪熊", "机械狗"],
        sticker_core: ["爱心贴纸", "创可贴"],
        sticker_decor: ["星星", "花瓣"],
        background_scene: ["卧室", "雨中街道", "图书馆", "太空舱"]
    }
};

const VAR_GROUPS = {
    character: { label: "人物 (CHARACTER)", keys: ["role", "subject", "character_companion", "expressions"], color: "#3b82f6" },
    action: { label: "动作 (ACTION)", keys: ["grid_pose", "action_detail", "action_pose"], color: "#10b981" },
    visuals: { label: "画面 (VISUALS)", keys: ["layout_focus", "camera_angle", "connectors", "texture_zoom", "special_view", "art_style", "background_style", "lens_param", "lighting"], color: "#8b5cf6" },
    item: { label: "物品 (ITEM)", keys: ["underwear_style", "clothing", "clothing_male", "clothing_female", "bag_content", "cosmetics", "private_items", "fashion_deconstruct", "toy_companion", "sticker_core", "sticker_decor"], color: "#f59e0b" },
    location: { label: "地点 (LOCATION)", keys: ["background_scene"], color: "#ef4444" },
    other: { label: "其他变量", keys: [], color: "#6b7280" }
};

// --- 状态管理 ---
let state = {
    templates: JSON.parse(localStorage.getItem('pf_v6_tpl')) || DEFAULT_DATA.templates,
    options: JSON.parse(localStorage.getItem('pf_v6_opt')) || DEFAULT_DATA.options,
    activeId: localStorage.getItem('pf_v6_id') || 't1',
    values: JSON.parse(localStorage.getItem('pf_v6_val')) || {},
    tab: 'editor', // templates, config, editor
    mode: 'fill'   // fill, code
};

// --- 核心函数 ---
function save() {
    localStorage.setItem('pf_v6_tpl', JSON.stringify(state.templates));
    localStorage.setItem('pf_v6_opt', JSON.stringify(state.options));
    localStorage.setItem('pf_v6_id', state.activeId);
    localStorage.setItem('pf_v6_val', JSON.stringify(state.values));
    render();
}

function getActiveTpl() {
    return state.templates.find(t => t.id === state.activeId) || state.templates[0];
}

function getVars(content) {
    const regex = /\{\{([^}]+)\}\}/g, found = new Set();
    let m;
    while ((m = regex.exec(content)) !== null) found.add(m[1].trim());
    return Array.from(found);
}

function genText(html = false) {
    const tpl = getActiveTpl();
    if (!tpl) return "";
    let txt = tpl.content;
    const vars = getVars(txt);
    
    if (html) {
        return txt.split(/(\{\{[^}]+\}\})/g).map(p => {
            if (p.startsWith('{{') && p.endsWith('}}')) {
                const k = p.slice(2, -2).trim();
                const v = state.values[k];
                return `<span class="hl">${v || p}</span>`;
            }
            return p;
        }).join('');
    } else {
        vars.forEach(v => txt = txt.split(`{{${v}}}`).join(state.values[v] || `{{${v}}`));
        return txt;
    }
}

// --- 渲染逻辑 ---
function render() {
    // 1. 渲染模版列表 (Mobile & PC)
    const tplHtml = state.templates.map(t => `
        <div class="template-item ${t.id === state.activeId ? 'active' : ''}" onclick="selectTemplate('${t.id}')">
            <div class="tpl-header">
                <div class="tpl-title">${t.title}</div>
            </div>
            <div style="font-size:12px;color:#9ca3af;margin-bottom:8px;">${t.content.substring(0,25)}...</div>
            <div class="tpl-actions">
                <button class="btn-icon" onclick="editTemplate('${t.id}', event)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                <button class="btn-icon" onclick="copyTemplate('${t.id}', event)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                <button class="btn-icon danger" onclick="deleteTemplate('${t.id}', event)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
            </div>
        </div>
    `).join('');
    document.getElementById('mobile-template-list').innerHTML = tplHtml;
    document.getElementById('pc-template-list').innerHTML = tplHtml;

    // 2. 渲染词库配置 (Config)
    const vars = Object.keys(state.options);
    // 分组
    const groups = { other: [] };
    Object.keys(VAR_GROUPS).forEach(k => groups[k] = []);
    vars.forEach(v => {
        let matched = false;
        for (const [k, cfg] of Object.entries(VAR_GROUPS)) {
            if (cfg.keys.includes(v)) { groups[k].push(v); matched = true; break; }
        }
        if (!matched) groups.other.push(v);
    });

    let configHtml = '';
    Object.entries(groups).forEach(([k, list]) => {
        if (list.length === 0) return;
        const cfg = VAR_GROUPS[k] || VAR_GROUPS.other;
        configHtml += `<div class="config-group"><div class="config-group-header" style="color:${cfg.color}"><span>●</span> ${cfg.label}</div>`;
        list.forEach(v => {
            const opts = state.options[v] || [];
            configHtml += `
                <div class="var-config-card" id="conf-card-${v}">
                    <div class="var-header" onclick="toggleConfigCard('${v}')">
                        <div class="var-name">
                            <span>${v}</span>
                            <span class="var-key">{{${v}}}</span>
                        </div>
                        <span style="font-size:12px;color:#9ca3af">${opts.length} 个选项 ▼</span>
                    </div>
                    <div class="var-body">
                        ${opts.map((o, i) => `
                            <div class="option-item">
                                <span>${o}</span>
                                <button onclick="removeOption('${v}', ${i})" style="color:#ef4444;">×</button>
                            </div>
                        `).join('')}
                        <div class="add-option-row">
                            <input class="add-input" id="input-new-${v}" placeholder="输入新选项...">
                            <button class="add-btn-small" onclick="addOption('${v}')">+</button>
                        </div>
                    </div>
                </div>
            `;
        });
        configHtml += `</div>`;
    });
    document.getElementById('config-list').innerHTML = configHtml;

    // 3. 渲染 Editor
    const tpl = getActiveTpl();
    if (tpl) {
        document.getElementById('editor-title').innerText = tpl.title;
        const tVars = getVars(tpl.content);
        
        let inputsHtml = '';
        tVars.forEach(v => {
            const val = state.values[v] || '';
            const opts = state.options[v] || [];
            inputsHtml += `
                <div class="field-card">
                    <div class="field-label">${v}</div>
                    <div class="field-input-wrapper">
                        <input class="field-input" value="${val}" oninput="updateVal('${v}', this.value)" placeholder="输入...">
                        ${opts.length ? `<div class="field-dropdown-btn" onclick="showDropdown('${v}')">▼</div>` : ''}
                    </div>
                    <div id="drop-${v}" style="display:none;background:white;border:1px solid #eee;margin-top:4px;max-height:150px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);border-radius:6px;">
                        ${opts.map(o => `<div style="padding:8px 12px;font-size:13px;cursor:pointer;border-bottom:1px solid #f9fafb;" onclick="updateVal('${v}','${o}'); hideDropdown('${v}')">${o}</div>`).join('')}
                    </div>
                </div>
            `;
        });
        document.getElementById('editor-inputs').innerHTML = inputsHtml || '<div style="padding:20px;text-align:center;color:#9ca3af;font-size:12px;">无变量，请检查模版</div>';
        
        // 预览
        const previewHtml = genText(true);
        document.getElementById('pc-preview').innerHTML = previewHtml;
        
        // 源码模式同步
        document.getElementById('tpl-title-input').value = tpl.title;
        document.getElementById('tpl-content-input').value = tpl.content;
    }

    // 4. 视图切换状态
    document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${state.tab}`).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-${state.tab}`)?.classList.add('active');

    document.querySelectorAll('.pc-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`pc-tab-${state.tab}`)?.classList.add('active');
    
    // 源码/填空模式
    document.getElementById('editor-inputs').style.display = state.mode === 'fill' ? 'block' : 'none';
    document.getElementById('code-editor').style.display = state.mode === 'code' ? 'flex' : 'none';
}

// --- 交互动作 ---
window.switchTab = (tab) => { state.tab = tab; save(); }
window.switchMode = () => { state.mode = state.mode === 'fill' ? 'code' : 'fill'; save(); }

window.selectTemplate = (id) => {
    state.activeId = id; 
    state.tab = 'editor'; // 选中后自动跳 Editor
    save();
}

window.createNewTemplate = () => {
    const id = 't' + Date.now();
    state.templates.push({ id, title: '新模版', content: '输入内容，使用 {{变量}} ...' });
    state.activeId = id;
    state.tab = 'editor';
    save();
}

window.editTemplate = (id, e) => {
    e.stopPropagation();
    state.activeId = id;
    state.tab = 'editor';
    state.mode = 'code'; // 直接进源码模式改标题
    save();
}

window.copyTemplate = (id, e) => {
    e.stopPropagation();
    const t = state.templates.find(x => x.id === id);
    const newId = 't' + Date.now();
    state.templates.push({ ...t, id: newId, title: t.title + ' (副本)' });
    state.activeId = newId;
    save();
}

window.deleteTemplate = (id, e) => {
    e.stopPropagation();
    if (state.templates.length <= 1) return alert('至少保留一个');
    if (confirm('确定删除?')) {
        state.templates = state.templates.filter(x => x.id !== id);
        state.activeId = state.templates[0].id;
        save();
    }
}

window.toggleConfigCard = (v) => {
    const el = document.getElementById(`conf-card-${v}`);
    el.classList.toggle('open');
}

window.addOption = (v) => {
    const input = document.getElementById(`input-new-${v}`);
    if (input.value.trim()) {
        if (!state.options[v]) state.options[v] = [];
        state.options[v].push(input.value.trim());
        input.value = '';
        save();
    }
}

window.removeOption = (v, idx) => {
    state.options[v].splice(idx, 1);
    save();
}

window.updateVal = (k, v) => { state.values[k] = v; save(); }
window.showDropdown = (k) => { document.getElementById(`drop-${k}`).style.display = 'block'; }
window.hideDropdown = (k) => { document.getElementById(`drop-${k}`).style.display = 'none'; }

// 源码编辑监听
document.getElementById('tpl-title-input').addEventListener('input', (e) => {
    state.templates.find(t => t.id === state.activeId).title = e.target.value;
    save(); // 触发全量渲染更新列表标题
});
document.getElementById('tpl-content-input').addEventListener('input', (e) => {
    state.templates.find(t => t.id === state.activeId).content = e.target.value;
    save();
});

window.copyResult = () => { navigator.clipboard.writeText(genText()).then(()=>alert('已复制')); }
window.exportImage = () => {
    html2canvas(document.getElementById('pc-preview')).then(c => {
        const a = document.createElement('a');
        a.download = 'prompt.png';
        a.href = c.toDataURL();
        a.click();
    });
}

// 启动
render();
</script>
</body>
</html>