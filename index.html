<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>提示词填空器 (Prompt Fill Tool) V0.5.0</title>
<style>
    /* --- 核心样式 (原生 CSS 替代 Tailwind) --- */
    :root {
        --primary: #4f46e5;
        --primary-bg: #eef2ff;
        --border: #e5e7eb;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --bg-body: #f9fafb;
        --bg-white: #ffffff;
        --shadow: 0 1px 3px rgba(0,0,0,0.1);
        --radius: 12px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* 布局容器 */
    .app-container { display: flex; flex: 1; overflow: hidden; position: relative; }
    .sidebar { width: 300px; background: var(--bg-white); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; transition: transform 0.3s; }
    .main-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-white); position: relative; overflow: hidden; }
    .config-panel { width: 320px; background: var(--bg-white); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 30; transition: transform 0.3s; }

    /* 通用组件 */
    button { cursor: pointer; border: none; background: none; outline: none; transition: 0.2s; }
    button:active { transform: scale(0.96); }
    .btn-primary { background: var(--primary); color: white; padding: 10px 16px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-ghost { color: var(--text-sub); padding: 6px; border-radius: 6px; }
    .btn-ghost:hover { background: #f3f4f6; color: var(--text-main); }
    
    .input-box { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; }
    .input-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-bg); }

    /* 顶部工具栏 */
    .toolbar { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; background: var(--bg-white); flex-shrink: 0; }
    .toolbar-group { display: flex; gap: 8px; background: #f3f4f6; padding: 4px; border-radius: 8px; }
    .mode-btn { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: var(--text-sub); }
    .mode-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow); }

    /* 滚动条 */
    .scroll-y { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .scroll-y::-webkit-scrollbar { width: 5px; }
    .scroll-y::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }

    /* 模版列表 */
    .template-item { padding: 12px; margin: 8px 12px; border: 1px solid transparent; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .template-item:hover { background: #f9fafb; border-color: var(--border); }
    .template-item.active { background: var(--primary-bg); border-color: #c7d2fe; }
    .template-indicator { width: 4px; height: 24px; border-radius: 4px; background: #e5e7eb; transition: 0.2s; }
    .template-item.active .template-indicator { background: var(--primary); }
    .template-title { font-size: 14px; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* 填空区域 */
    .split-view { display: flex; height: 100%; }
    .editor-inputs { flex: 1; padding: 20px; background: #f9fafb; border-right: 1px solid var(--border); max-width: 450px; padding-bottom: 100px; }
    .editor-preview { flex: 1; padding: 40px; background: #f3f4f6; overflow-y: auto; display: none; } /* PC默认显示 */
    .preview-card { background: white; padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow); min-height: 600px; white-space: pre-wrap; font-family: monospace; line-height: 1.8; font-size: 14px; color: #374151; }

    /* 输入卡片 */
    .var-group { margin-bottom: 24px; animation: slideIn 0.3s ease; }
    .var-group-title { font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; text-transform: uppercase; }
    .var-input-card { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 10px; position: relative; display: flex; flex-direction: column; transition: 0.2s; }
    .var-input-card:focus-within { border-color: var(--primary); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1); transform: translateY(-1px); }
    .var-label { font-size: 10px; color: #9ca3af; font-weight: 700; margin-bottom: 4px; }
    .var-input { border: none; outline: none; font-size: 14px; width: 100%; color: var(--text-main); background: transparent; }
    .var-select-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #9ca3af; padding: 4px; }
    .dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; }
    .dropdown-item { padding: 10px 12px; font-size: 13px; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
    .dropdown-item:hover { background: var(--primary-bg); color: var(--primary); }

    /* 高亮文本 */
    .hl-var { display: inline-block; margin: 0 2px; padding: 0 4px; border-radius: 4px; font-weight: bold; border-bottom: 2px solid; }
    .hl-filled { background: #e0e7ff; color: #4338ca; border-color: #6366f1; }
    .hl-empty { background: #fef3c7; color: #b45309; border-color: #f59e0b; border-style: dashed; }

    /* 底部导航 (移动端) */
    .bottom-nav { display: none; height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border); position: fixed; bottom: 0; left: 0; right: 0; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
    .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #9ca3af; font-size: 10px; font-weight: 500; width: 100%; }
    .nav-btn.active { color: var(--primary); }

    /* 移动端预览卡片 */
    .mobile-preview-widget { display: none; background: white; border: 1px solid #e0e7ff; border-radius: var(--radius); padding: 12px; margin-bottom: 16px; font-size: 12px; color: #4b5563; max-height: 120px; overflow-y: auto; font-family: monospace; line-height: 1.6; }

    /* 动画 */
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* 响应式 */
    @media (min-width: 1024px) {
        .editor-preview { display: block; }
        .config-panel { position: relative; transform: none !important; }
        .sidebar { position: relative; transform: none !important; }
        .mobile-only { display: none !important; }
    }
    @media (max-width: 1023px) {
        .sidebar { position: fixed; top: 0; bottom: 60px; left: 0; transform: translateX(-100%); width: 100%; z-index: 40; }
        .config-panel { position: fixed; top: 0; bottom: 60px; right: 0; transform: translateX(100%); width: 100%; z-index: 40; }
        .sidebar.open { transform: translateX(0); }
        .config-panel.open { transform: translateX(0); }
        .bottom-nav { display: flex; }
        .editor-inputs { max-width: 100%; border-right: none; }
        .mobile-preview-widget { display: block; }
        .pc-only { display: none !important; }
        .app-container { padding-bottom: 60px; } /* 为底部导航留空 */
    }
</style>
<!-- HTML2Canvas (唯一外部脚本，即使失败也不影响主功能) -->
<script src="https://cdn.staticfile.net/html2canvas/1.4.1/html2canvas.min.js" onerror="console.warn('Screenshot lib failed to load')"></script>
</head>
<body>

<div class="app-container">
    
    <!-- 1. 左侧：模版列表 -->
    <div id="sidebar" class="sidebar">
        <div class="toolbar" style="justify-content: flex-start; gap: 10px;">
            <div style="font-weight: 800; font-size: 18px; color: var(--primary);">提示词填空器</div>
            <div style="font-size: 10px; background: var(--primary-bg); color: var(--primary); padding: 2px 6px; border-radius: 4px;">V0.5.0</div>
        </div>
        <div id="template-list" class="scroll-y" style="padding: 10px 0;">
            <!-- 模版列表由 JS 生成 -->
        </div>
        <div style="padding: 16px; border-top: 1px solid var(--border);">
            <button class="btn-primary" style="width: 100%;" onclick="createNewTemplate()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                新建模版
            </button>
        </div>
    </div>

    <!-- 2. 中间：主要工作区 -->
    <div class="main-area">
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="mode-btn active" id="btn-mode-fill" onclick="switchMode('fill')">交互填空</button>
                <button class="mode-btn" id="btn-mode-code" onclick="switchMode('code')">源码编辑</button>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn-ghost pc-only" onclick="toggleConfig()" title="词库配置">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
                </button>
                <button class="btn-ghost pc-only" onclick="exportImage()" title="保存长图">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                <button class="btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="copyResult()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    复制结果
                </button>
            </div>
        </div>

        <!-- 填空模式视图 -->
        <div id="view-fill" class="split-view">
            <div class="editor-inputs scroll-y">
                <!-- 移动端小预览 -->
                <div class="mobile-preview-widget" id="mobile-preview-text"></div>
                <!-- 动态输入框 -->
                <div id="input-container"></div>
                <div id="empty-state" style="text-align: center; color: #9ca3af; padding: 40px; font-size: 12px; display: none;">
                    当前模版没有检测到变量。<br>请切换到“源码编辑”模式添加 {{variable}}。
                </div>
            </div>
            
            <div class="editor-preview">
                <div id="preview-card" class="preview-card"></div>
                <div style="margin-top: 20px; color: #d1d5db; font-size: 12px; display: flex; justify-content: space-between;">
                    <span>PROMPT FILL TOOL</span>
                    <span>GENERATED BY AI</span>
                </div>
            </div>
        </div>

        <!-- 源码模式视图 -->
        <div id="view-code" class="split-view" style="display: none;">
            <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                <input id="template-title-input" type="text" placeholder="模版标题" style="padding: 16px 24px; font-size: 16px; font-weight: bold; border: none; border-bottom: 1px solid var(--border); outline: none;">
                <textarea id="template-content-input" style="flex: 1; padding: 24px; border: none; outline: none; resize: none; font-family: monospace; font-size: 14px; line-height: 1.6; background: #f9fafb;" placeholder="在此输入 Prompt 内容..."></textarea>
            </div>
        </div>
    </div>

    <!-- 3. 右侧：词库配置 -->
    <div id="config-panel" class="config-panel">
        <div class="toolbar">
            <div style="font-weight: 700;">词库配置</div>
            <button class="btn-ghost mobile-only" onclick="closeAllPanels()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="scroll-y" style="padding: 16px;">
            <div style="margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap;" id="config-keys"></div>
            <div style="background: #f9fafb; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                <div style="font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 8px; text-transform: uppercase;" id="current-config-key">ROLE</div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input id="new-option-input" type="text" placeholder="新增选项..." style="flex: 1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; outline: none;">
                    <button class="btn-primary" style="padding: 6px 10px;" onclick="addOption()">+</button>
                </div>
                <div id="option-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

</div>

<!-- 底部导航 (移动端) -->
<div class="bottom-nav">
    <button class="nav-btn" onclick="openPanel('sidebar')" id="nav-templates">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        模版
    </button>
    <button class="nav-btn active" onclick="openPanel('main')" id="nav-fill">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        填空
    </button>
    <button class="nav-btn" onclick="openPanel('config')" id="nav-config">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
        词库
    </button>
</div>

<script>
    // --- 核心逻辑 (Vanilla JS) ---

    // 1. 数据预设
    const DEFAULT_TEMPLATES = [
        { id: 't1', title: '角色概念分解图', content: "Role (角色设定)\n你是一位顶尖的 {{role}} ，擅长制作详尽的角色设定图。你具备“像素级拆解”的能力。\n\nTask (任务目标)\n生成一张“全景式角色深度概念分解图”。该图片必须包含 {{layout_focus}} ，并在其周围环绕展示该人物的服装分层、不同表情、核心道具。\n\nVisual Guidelines:\n1. 构图: 中心位放置角色的 {{layout_focus}} 。\n2. 拆解内容:\n•服装分层: 例如： {{clothing}}\n•私密内着: 例如： {{underwear_style}}\n•表情集: 如： {{expressions}}\n•材质特写: 例如： {{texture_zoom}}\n\nStyle:\n•画风: {{art_style}}\n•灯光: {{lighting}}" },
        { id: 't2', title: '3x3 摄影网格', content: "创建一个 3x3 的摄影网格，展示 {{subject}} 的不同角度。\n风格: {{art_style}}\n光线: {{lighting}}\n每个格子应该展示: {{action_pose}}\n构图参考: {{camera_angle}}" }
    ];
    
    const DEFAULT_OPTIONS = {
        role: ["游戏概念设计师", "时尚摄影师", "电影导演"],
        subject: ["赛博朋克黑客", "森林精灵", "都市白领"],
        art_style: ["2D 插画", "吉卜力风格", "写实摄影"],
        layout_focus: ["全身立绘", "半身像", "头部特写"],
        lighting: ["自然光", "赛博霓虹", "伦勃朗光"],
        clothing: ["机能风外套", "丝绸长裙", "战术背心"],
        underwear_style: ["运动内衣", "蕾丝套装", "简约棉质"],
        expressions: ["冷漠", "狂喜", "羞涩"]
    };

    const VAR_GROUPS = {
        character: { label: "人物", keys: ["role", "subject", "character_companion", "expressions"], color: "#3b82f6" },
        action: { label: "动作", keys: ["grid_pose", "action_detail", "action_pose"], color: "#10b981" },
        visuals: { label: "画面", keys: ["layout_focus", "camera_angle", "connectors", "texture_zoom", "art_style", "lighting"], color: "#8b5cf6" },
        item: { label: "物品", keys: ["clothing", "underwear_style", "bag_content", "cosmetics"], color: "#f59e0b" },
        other: { label: "其他变量", keys: [], color: "#6b7280" }
    };

    // 2. 状态管理
    let state = {
        templates: JSON.parse(localStorage.getItem('pf_templates')) || DEFAULT_TEMPLATES,
        options: JSON.parse(localStorage.getItem('pf_options')) || DEFAULT_OPTIONS,
        activeId: localStorage.getItem('pf_active_id') || 't1',
        values: JSON.parse(localStorage.getItem('pf_values')) || {},
        activeConfigKey: 'role'
    };

    // 3. 辅助函数
    function saveState() {
        localStorage.setItem('pf_templates', JSON.stringify(state.templates));
        localStorage.setItem('pf_options', JSON.stringify(state.options));
        localStorage.setItem('pf_active_id', state.activeId);
        localStorage.setItem('pf_values', JSON.stringify(state.values));
    }

    function getActiveTemplate() {
        return state.templates.find(t => t.id === state.activeId) || state.templates[0] || {id:'err', content:''};
    }

    function getVariables(content) {
        const regex = /\{\{([^}]+)\}\}/g;
        const found = new Set();
        let m;
        while ((m = regex.exec(content)) !== null) found.add(m[1].trim());
        return Array.from(found);
    }

    function generateText(html = false) {
        const tpl = getActiveTemplate();
        const vars = getVariables(tpl.content);
        let text = tpl.content;
        
        if (html) {
            // 生成带高亮的 HTML
            const parts = text.split(/(\{\{[^}]+\}\})/g);
            return parts.map(part => {
                if (part.startsWith('{{') && part.endsWith('}}')) {
                    const key = part.slice(2, -2).trim();
                    const val = state.values[key];
                    const cls = val ? 'hl-filled' : 'hl-empty';
                    return `<span class="hl-var ${cls}">${val || part}</span>`;
                }
                return part; // 简单文本转义可略，这里直接输出
            }).join('');
        } else {
            // 生成纯文本
            vars.forEach(v => {
                text = text.split(`{{${v}}}`).join(state.values[v] || `{{${v}}`);
            });
            return text;
        }
    }

    // 4. 渲染逻辑
    function render() {
        renderSidebar();
        renderInputs();
        renderPreview();
        renderConfig();
        renderCodeEditor();
    }

    function renderSidebar() {
        const list = document.getElementById('template-list');
        list.innerHTML = state.templates.map(t => `
            <div class="template-item ${t.id === state.activeId ? 'active' : ''}" onclick="selectTemplate('${t.id}')">
                <div class="template-indicator"></div>
                <div class="template-title">${t.title}</div>
                ${t.id === state.activeId ? `<button class="btn-ghost" style="padding:4px" onclick="deleteTemplate(event, '${t.id}')">×</button>` : ''}
            </div>
        `).join('');
    }

    function renderInputs() {
        const tpl = getActiveTemplate();
        const vars = getVariables(tpl.content);
        const container = document.getElementById('input-container');
        const emptyState = document.getElementById('empty-state');

        if (vars.length === 0) {
            container.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }
        emptyState.style.display = 'none';

        // 分组逻辑
        const groups = { other: [] };
        Object.keys(VAR_GROUPS).forEach(k => groups[k] = []);
        vars.forEach(v => {
            let matched = false;
            for (const [key, cfg] of Object.entries(VAR_GROUPS)) {
                if (cfg.keys.includes(v)) { groups[key].push(v); matched = true; break; }
            }
            if (!matched) groups.other.push(v);
        });

        // 生成 HTML
        let html = '';
        Object.entries(groups).forEach(([key, list]) => {
            if (list.length === 0) return;
            const cfg = VAR_GROUPS[key] || VAR_GROUPS.other;
            html += `<div class="var-group"><div class="var-group-title" style="color:${cfg.color}">
                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${cfg.color}"></span>
                ${cfg.label}
            </div>`;
            
            list.forEach(v => {
                const val = state.values[v] || '';
                html += `
                    <div class="var-input-card" style="border-left: 3px solid ${cfg.color}">
                        <div class="var-label">${v}</div>
                        <input class="var-input" value="${val}" oninput="updateValue('${v}', this.value)" placeholder="输入...">
                        <button class="var-select-btn" onclick="toggleDropdown('${v}', this)">▼</button>
                        <div class="dropdown-menu" id="dropdown-${v}">
                            ${(state.options[v] || []).map(opt => 
                                `<div class="dropdown-item" onclick="selectOption('${v}', '${opt}')">${opt}</div>`
                            ).join('') || '<div style="padding:10px;color:#ccc;text-align:center">无选项</div>'}
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        });
        
        // 只有当变量列表发生变化时才重绘，避免输入焦点丢失
        // 简单处理：这里每次切换模版渲染。输入时不重绘整个列表，只更新值。
        // 为了性能，我们这里只在 init 或者切换模版时完全重绘。
        // 但是 updateValue 触发 renderPreview，不触发 renderInputs。
        if (container.dataset.tplId !== tpl.id) {
            container.innerHTML = html;
            container.dataset.tplId = tpl.id;
        }
    }

    function renderPreview() {
        const html = generateText(true);
        document.getElementById('preview-card').innerHTML = html;
        document.getElementById('mobile-preview-text').innerHTML = html;
    }

    function renderCodeEditor() {
        const tpl = getActiveTemplate();
        // 避免在输入时重置光标，只在切换模版时更新值
        const titleInput = document.getElementById('template-title-input');
        const contentInput = document.getElementById('template-content-input');
        if (titleInput.dataset.tplId !== tpl.id) {
            titleInput.value = tpl.title;
            contentInput.value = tpl.content;
            titleInput.dataset.tplId = tpl.id;
        }
    }

    function renderConfig() {
        const keysContainer = document.getElementById('config-keys');
        const listContainer = document.getElementById('option-list');
        const currentKeyLabel = document.getElementById('current-config-key');
        
        // 渲染 Keys
        const keys = Object.keys(state.options);
        if (!keys.includes(state.activeConfigKey) && keys.length > 0) state.activeConfigKey = keys[0];

        keysContainer.innerHTML = keys.map(k => `
            <button onclick="setConfigKey('${k}')" style="padding:4px 8px;border-radius:12px;font-size:12px;border:1px solid var(--border);background:${k === state.activeConfigKey ? '#1f2937' : 'white'};color:${k === state.activeConfigKey ? 'white' : '#374151'}">${k}</button>
        `).join('');

        // 渲染 Options
        currentKeyLabel.innerText = state.activeConfigKey;
        const opts = state.options[state.activeConfigKey] || [];
        listContainer.innerHTML = opts.map((o, idx) => `
            <div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #f3f4f6;font-size:13px;">
                <span>${o}</span>
                <button style="color:#ef4444;" onclick="deleteOption('${state.activeConfigKey}', ${idx})">×</button>
            </div>
        `).join('');
    }

    // 5. 交互动作
    window.selectTemplate = (id) => {
        state.activeId = id;
        saveState();
        render(); // 全量重绘
        // 强制刷新输入区
        document.getElementById('input-container').dataset.tplId = '';
        renderInputs();
        
        // 移动端自动切回填空 Tab
        if (window.innerWidth < 1024) openPanel('main');
    };

    window.createNewTemplate = () => {
        const id = 't' + Date.now();
        state.templates.push({ id, title: '新模版', content: '在这里输入内容，使用 {{变量}} ...' });
        selectTemplate(id);
    };

    window.deleteTemplate = (e, id) => {
        e.stopPropagation();
        if (state.templates.length <= 1) return alert('至少保留一个模版');
        if (confirm('确定删除吗？')) {
            state.templates = state.templates.filter(t => t.id !== id);
            if (state.activeId === id) state.activeId = state.templates[0].id;
            saveState();
            render();
            document.getElementById('input-container').dataset.tplId = ''; // Force refresh
            renderInputs();
        }
    };

    window.updateValue = (key, val) => {
        state.values[key] = val;
        saveState();
        renderPreview(); // 只更新预览
    };

    window.toggleDropdown = (key, btn) => {
        const menu = document.getElementById(`dropdown-${key}`);
        const isVisible = menu.style.display === 'block';
        // 关闭所有
        document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
        if (!isVisible) menu.style.display = 'block';
    };

    window.selectOption = (key, val) => {
        state.values[key] = val;
        saveState();
        // 更新输入框显示
        const inputs = document.querySelectorAll('.var-input');
        // 找到对应的 input 更新 value (简单粗暴重绘也可以，但为了体验最好直接操作 DOM)
        document.getElementById('input-container').dataset.tplId = ''; // 标记脏数据
        renderInputs(); 
        renderPreview();
    };

    // 点击外部关闭下拉
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.var-input-card')) {
            document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
        }
    });

    window.switchMode = (mode) => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-mode-${mode}`).classList.add('active');
        document.getElementById('view-fill').style.display = mode === 'fill' ? 'flex' : 'none';
        document.getElementById('view-code').style.display = mode === 'code' ? 'flex' : 'none';
        if (mode === 'code') renderCodeEditor();
    };

    // 源码编辑监听
    document.getElementById('template-title-input').addEventListener('input', (e) => {
        const tpl = state.templates.find(t => t.id === state.activeId);
        if (tpl) { tpl.title = e.target.value; saveState(); renderSidebar(); }
    });
    document.getElementById('template-content-input').addEventListener('input', (e) => {
        const tpl = state.templates.find(t => t.id === state.activeId);
        if (tpl) { 
            tpl.content = e.target.value; 
            saveState(); 
            // 标记输入区脏数据，切换回填空模式时会自动重绘
            document.getElementById('input-container').dataset.tplId = ''; 
        }
    });

    // 词库配置
    window.setConfigKey = (key) => { state.activeConfigKey = key; renderConfig(); };
    window.addOption = () => {
        const input = document.getElementById('new-option-input');
        const val = input.value.trim();
        if (val) {
            if (!state.options[state.activeConfigKey]) state.options[state.activeConfigKey] = [];
            state.options[state.activeConfigKey].push(val);
            input.value = '';
            saveState();
            renderConfig();
        }
    };
    window.deleteOption = (key, idx) => {
        state.options[key].splice(idx, 1);
        saveState();
        renderConfig();
    };

    // 复制与导出
    window.copyResult = () => {
        const text = generateText();
        navigator.clipboard.writeText(text).then(() => alert('已复制到剪贴板'));
    };
    window.exportImage = () => {
        const el = document.getElementById('preview-card');
        html2canvas(el, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'prompt.png';
            link.href = canvas.toDataURL();
            link.click();
        }).catch(() => alert('生成图片失败'));
    };

    // 移动端面板控制
    window.openPanel = (panelName) => {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('config-panel').classList.remove('open');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        if (panelName === 'sidebar') {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('nav-templates').classList.add('active');
        } else if (panelName === 'config') {
            document.getElementById('config-panel').classList.add('open');
            document.getElementById('nav-config').classList.add('active');
        } else {
            document.getElementById('nav-fill').classList.add('active');
        }
    };
    window.closeAllPanels = () => openPanel('main');
    window.toggleConfig = () => {
        // PC端配置面板开关逻辑 (这里简化处理，PC端始终显示或覆盖)
        const panel = document.getElementById('config-panel');
        panel.style.transform = panel.style.transform === 'translateX(100%)' ? 'translateX(0)' : 'translateX(100%)';
        // PC端我们用 absolute 或 fixed 覆盖，或者上面的 CSS 已经处理了
        // 实际上上面的 CSS 对于 PC (min-width: 1024) 设定了 config-panel 始终显示。
        // 如果想做开关，需要 JS 修改 style。
        // 鉴于 V0.5 追求稳定，PC端配置栏常驻即可，或者做一个简单的 Overlay。
        // 这里为了简单，PC端点击按钮时弹出一个 Alert 提示“请在右侧操作”或者简单切换显示。
        alert("PC端配置面板已在右侧显示"); 
    };

    // 初始化
    render();

</script>
</body>
</html>