<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>å’’è¯­é­”ç›’ (Prompt Fill Tool) V0.6.1</title>
<style>
    /* --- æ ¸å¿ƒå˜é‡ --- */
    :root {
        --primary: #4f46e5;
        --primary-bg: #eef2ff;
        --border: #e5e7eb;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --bg-body: #f9fafb;
        --bg-white: #ffffff;
        --danger: #ef4444;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --modal-bg: rgba(0, 0, 0, 0.5);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* --- å¸ƒå±€æ¡†æ¶ --- */
    .app-container { display: flex; flex: 1; overflow: hidden; position: relative; }
    .sidebar { width: 300px; background: var(--bg-white); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }
    .main-viewport { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); position: relative; overflow: hidden; }
    
    .view-container { flex: 1; display: none; flex-direction: column; overflow: hidden; height: 100%; }
    .view-container.active { display: flex; }

    /* --- é€šç”¨ç»„ä»¶ --- */
    button { cursor: pointer; border: none; background: none; outline: none; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    button:active { transform: scale(0.96); }
    
    .btn-primary { background: var(--primary); color: white; padding: 12px; border-radius: 8px; font-weight: 500; width: 100%; font-size: 14px; gap: 6px; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
    .btn-primary:hover { opacity: 0.9; }
    
    .btn-icon { color: #9ca3af; padding: 6px; border-radius: 6px; }
    .btn-icon:hover { background: #f3f4f6; color: var(--text-main); }
    .btn-icon.danger:hover { background: #fee2e2; color: var(--danger); }

    .scroll-y { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .scroll-y::-webkit-scrollbar { width: 4px; }
    .scroll-y::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }

    /* --- æ¨¡ç‰ˆåˆ—è¡¨é¡¹ --- */
    .template-item { padding: 16px; margin: 12px 16px; background: var(--bg-white); border-radius: var(--radius); cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .template-item:hover { box-shadow: var(--shadow); }
    .template-item.active { border: 1px solid #c7d2fe; background: var(--bg-white); box-shadow: 0 0 0 2px var(--primary-bg); position: relative; }
    .template-item.active::before { content: ''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 4px; background: var(--primary); border-radius: 0 4px 4px 0; }
    .tpl-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .tpl-title { font-size: 15px; font-weight: 600; color: var(--text-main); }
    .tpl-actions { display: none; gap: 4px; }
    .template-item.active .tpl-actions { display: flex; }
    
    /* --- Editor è§†å›¾ --- */
    .editor-layout { display: flex; height: 100%; flex-direction: column; }
    @media (min-width: 1024px) { .editor-layout { flex-direction: row; } }
    
    .editor-left { flex: 1; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-white); max-width: 100%; }
    @media (min-width: 1024px) { .editor-left { max-width: 450px; } }
    
    .editor-right { flex: 1; background: #f3f4f6; padding: 30px; overflow-y: auto; display: none; }
    @media (min-width: 1024px) { .editor-right { display: block; } }

    /* è¾“å…¥æ¡†æ ·å¼ (äº¤äº’ä¼˜åŒ–) */
    .field-card { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
    .field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .field-label { font-size: 13px; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 4px; }
    .field-var-key { font-size: 10px; color: #9ca3af; font-family: monospace; background: #f3f4f6; padding: 2px 4px; border-radius: 4px; }
    
    .field-input-container { position: relative; display: flex; gap: 8px; }
    .field-input { flex: 1; padding: 10px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; }
    .field-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-bg); }
    
    .field-select-btn { width: 40px; display: flex; align-items: center; justify-content: center; background: #eef2ff; color: var(--primary); border-radius: 8px; border: 1px solid #c7d2fe; cursor: pointer; transition: 0.2s; }
    .field-select-btn:active { transform: scale(0.95); background: #e0e7ff; }

    /* é¢„è§ˆå¡ç‰‡ */
    .preview-paper { background: white; padding: 40px; min-height: 600px; box-shadow: var(--shadow); border-radius: 8px; font-family: monospace; font-size: 14px; line-height: 1.8; color: #374151; white-space: pre-wrap; }
    .hl { background: #e0e7ff; color: var(--primary); border-bottom: 2px solid var(--primary); padding: 0 4px; border-radius: 4px; font-weight: bold; }

    /* åº•éƒ¨å¯¼èˆª (Mobile) */
    .bottom-nav { height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #9ca3af; font-size: 10px; font-weight: 500; width: 100%; }
    .nav-item.active { color: var(--primary); }
    
    /* PC é¡¶éƒ¨æ  */
    .pc-header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; background: white; }
    .pc-tabs { display: flex; gap: 4px; background: #f3f4f6; padding: 4px; border-radius: 8px; }
    .pc-tab { padding: 6px 16px; font-size: 13px; font-weight: 600; color: #6b7280; border-radius: 6px; }
    .pc-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    /* --- é€šç”¨å¼¹çª—é€‰æ‹©å™¨ (Modal) --- */
    .modal-overlay { position: fixed; inset: 0; background: var(--modal-bg); z-index: 100; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.2s; }
    .modal-overlay.open { display: flex; opacity: 1; }
    
    /* é»˜è®¤æ˜¯ Bottom Sheet (Mobile) */
    .modal-content { background: white; width: 100%; max-height: 80vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .modal-overlay.open .modal-content { transform: translateY(0); }
    
    /* PCç«¯æ”¹ä¸ºå±…ä¸­å¼¹çª— */
    @media (min-width: 1024px) {
        .modal-overlay { align-items: center; }
        .modal-content { width: 400px; max-height: 600px; border-radius: 16px; transform: scale(0.95); opacity: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-overlay.open .modal-content { transform: scale(1); opacity: 1; }
    }

    .modal-header { padding: 16px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-weight: 700; font-size: 16px; color: var(--text-main); }
    .modal-body { overflow-y: auto; padding: 0; flex: 1; }
    
    .select-item { padding: 12px 16px; border-bottom: 1px solid #f9fafb; cursor: pointer; font-size: 14px; color: #4b5563; transition: 0.1s; }
    .select-item:active { background: #f3f4f6; }
    .select-item:last-child { border-bottom: none; }
    .select-item.new-item-btn { color: var(--primary); font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 16px; border-top: 1px solid #eee; }

    /* å“åº”å¼æ˜¾ç¤ºæ§åˆ¶ */
    @media (min-width: 1024px) {
        .bottom-nav { display: none; }
        .sidebar { display: flex !important; }
        .view-template-mobile { display: none !important; }
    }
    @media (max-width: 1023px) {
        .sidebar { display: none; }
        .pc-header { display: none; }
        .view-container { padding-bottom: 60px; }
        .main-viewport { flex: 1; }
    }
</style>
</head>
<body>

<div class="app-container">
    
    <!-- å·¦ä¾§ï¼šæ¨¡ç‰ˆç®¡ç† (PC) -->
    <div class="sidebar pc-only-flex">
        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 18px; font-weight: 800; color: var(--primary);">å’’è¯­é­”ç›’</div>
            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Prompt Fill Tool V0.6.1</div>
        </div>
        <div id="pc-template-list" class="scroll-y" style="padding: 10px 0;"></div>
        <div style="padding: 16px; border-top: 1px solid var(--border);">
            <button class="btn-primary" onclick="createNewTemplate()">+ æ–°å»ºæ¨¡ç‰ˆ</button>
        </div>
    </div>

    <!-- ä¸»è§†å£ -->
    <div class="main-viewport">
        
        <!-- PC é¡¶éƒ¨æ  -->
        <div class="pc-header">
            <div class="pc-tabs">
                <button class="pc-tab active" onclick="switchTab('editor')" id="pc-tab-editor">Editor (å¡«ç©º)</button>
                <button class="pc-tab" onclick="switchTab('config')" id="pc-tab-config">è¯åº“é…ç½®</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" style="width: auto; padding: 8px 16px;" onclick="copyResult()">å¤åˆ¶ç»“æœ</button>
            </div>
        </div>

        <!-- è§†å›¾ 1: æ¨¡ç‰ˆç®¡ç† (Mobile) -->
        <div id="view-templates" class="view-container view-template-mobile">
            <div style="padding: 16px 20px; background: white; border-bottom: 1px solid var(--border);">
                <div style="font-size: 20px; font-weight: 800;">æ¨¡ç‰ˆç®¡ç†</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">åˆ‡æ¢æˆ–ç®¡ç†ä¸åŒ Prompt</div>
            </div>
            <div id="mobile-template-list" class="scroll-y" style="background: #f9fafb;"></div>
            <div style="padding: 16px; background: white; border-top: 1px solid var(--border);">
                <button class="btn-primary" onclick="createNewTemplate()">+ æ–°å»ºæ¨¡ç‰ˆ</button>
            </div>
        </div>

        <!-- è§†å›¾ 2: è¯åº“é…ç½® -->
        <div id="view-config" class="view-container">
            <div style="padding: 16px 20px; background: white; border-bottom: 1px solid var(--border);">
                <div style="font-size: 18px; font-weight: 800;">è¯åº“é…ç½®</div>
                <div style="font-size: 11px; color: #9ca3af;">ç®¡ç†åˆ†ç±»ä¸å€™é€‰é¡¹</div>
            </div>
            <div id="config-list" class="scroll-y" style="padding: 16px; background: var(--bg-body);"></div>
        </div>

        <!-- è§†å›¾ 3: Editor (å¡«ç©º) -->
        <div id="view-editor" class="view-container active">
            <div class="editor-layout">
                <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
                <div class="editor-left">
                    <div style="padding: 16px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 700; font-size: 14px;" id="editor-title">æœªé€‰æ‹©æ¨¡ç‰ˆ</span>
                        <button class="btn-icon" style="font-size: 12px;" onclick="switchMode()">åˆ‡æ¢æ¨¡å¼</button>
                    </div>
                    
                    <!-- Mobile Preview Bar -->
                    <div class="lg:hidden" style="padding: 12px; background: #eef2ff; border-bottom: 1px solid #e0e7ff; font-size: 12px; color: var(--primary); display: flex; justify-content: space-between; align-items: center;">
                        <span id="mobile-preview-hint">å®æ—¶é¢„è§ˆä¸­...</span>
                        <button style="font-weight: bold;" onclick="copyResult()">å¤åˆ¶</button>
                    </div>

                    <div id="editor-inputs" class="scroll-y"></div>
                    
                    <!-- Code Editor -->
                    <div id="code-editor" style="display: none; height: 100%; flex-direction: column;">
                        <input id="tpl-title-input" placeholder="æ¨¡ç‰ˆæ ‡é¢˜" style="padding: 16px; border-bottom: 1px solid #eee; outline: none; font-weight: bold;">
                        <textarea id="tpl-content-input" style="flex: 1; padding: 16px; outline: none; border: none; resize: none; line-height: 1.6;" placeholder="åœ¨æ­¤è¾“å…¥ Prompt..."></textarea>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šPC é¢„è§ˆåŒº -->
                <div class="editor-right">
                    <div id="pc-preview" class="preview-paper"></div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- åº•éƒ¨å¯¼èˆª (Mobile) -->
<div class="bottom-nav">
    <div class="nav-item" onclick="switchTab('templates')" id="nav-templates">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        æ¨¡ç‰ˆç®¡ç†
    </div>
    <div class="nav-item active" onclick="switchTab('editor')" id="nav-editor">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        Editor
    </div>
    <div class="nav-item" onclick="switchTab('config')" id="nav-config">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
        è¯åº“é…ç½®
    </div>
</div>

<!-- å¼¹çª—é€‰æ‹©å™¨ (Modal) -->
<div id="selection-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title" id="modal-title">é€‰æ‹©é€‰é¡¹</span>
            <button onclick="closeModal()" style="padding: 4px; color: #9ca3af;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="modal-body" id="modal-list">
            <!-- é€‰é¡¹åˆ—è¡¨ -->
        </div>
        <div class="select-item new-item-btn" onclick="addCustomOptionFromModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            æ·»åŠ è‡ªå®šä¹‰é€‰é¡¹
        </div>
    </div>
</div>

<script>
// --- æ•°æ®é…ç½® (å…¨é‡åŒæ­¥) ---
const VAR_MAP = {
    // Character
    role: "è§’è‰²èº«ä»½", subject: "ä¸»ä½“å¯¹è±¡", character_companion: "åˆå½±è§’è‰²", expressions: "è¡¨æƒ…é›†",
    // Action
    grid_pose: "ä¹å®«æ ¼åŠ¨ä½œ", action_detail: "åŠ¨ä½œç»†èŠ‚", action_pose: "äº’åŠ¨å§¿åŠ¿",
    // Visuals
    layout_focus: "æ„å›¾é‡å¿ƒ", camera_angle: "æ‹æ‘„è§’åº¦", connectors: "è§†è§‰å¼•å¯¼", texture_zoom: "æè´¨ç‰¹å†™",
    special_view: "ç‰¹æ®Šè§†è§’", art_style: "ç”»é£", background_style: "èƒŒæ™¯é£æ ¼", lens_param: "ä¹å®«æ ¼é•œå¤´", lighting: "ç¯å…‰å¸ƒç½®",
    // Items
    underwear_style: "ç§å¯†å†…ç€æ‹†è§£", clothing: "äººç‰©æœé¥°", clothing_male: "ç”·æ€§æœé¥°", clothing_female: "å¥³æ€§æœé¥°",
    bag_content: "éšèº«åŒ…è¢‹", cosmetics: "ç¾å¦†ä¸æŠ¤ç†", private_items: "ç§å¯†ç”Ÿæ´»ç‰©ä»¶", fashion_deconstruct: "ç©¿æ­è§£æ„",
    toy_companion: "äº’åŠ¨å…¬ä»”", sticker_core: "æ ¸å¿ƒè´´çº¸", sticker_decor: "è£…é¥°å…ƒç´ ",
    // Location
    background_scene: "èƒŒæ™¯åœºæ™¯"
};

const VAR_GROUPS = {
    character: { label: "äººç‰© (CHARACTER)", keys: ["role", "subject", "character_companion", "expressions"], color: "#3b82f6" },
    action: { label: "åŠ¨ä½œ (ACTION)", keys: ["grid_pose", "action_detail", "action_pose"], color: "#10b981" },
    visuals: { label: "ç”»é¢ (VISUALS)", keys: ["layout_focus", "camera_angle", "connectors", "texture_zoom", "special_view", "art_style", "background_style", "lens_param", "lighting"], color: "#8b5cf6" },
    item: { label: "ç‰©å“ (ITEM)", keys: ["underwear_style", "clothing", "clothing_male", "clothing_female", "bag_content", "cosmetics", "private_items", "fashion_deconstruct", "toy_companion", "sticker_core", "sticker_decor"], color: "#f59e0b" },
    location: { label: "åœ°ç‚¹ (LOCATION)", keys: ["background_scene"], color: "#ef4444" }
};

const DEFAULT_OPTIONS = {
    role: ["æ¸¸æˆä¸åŠ¨æ¼«æ¦‚å¿µç¾æœ¯è®¾è®¡å¤§å¸ˆ", "èµ„æ·±æ—¶å°šæ‘„å½±å¸ˆ", "ç”µå½±åˆ†é•œå¸ˆ", "äººè®¾ç”»å¸ˆ"],
    subject: ["å¥³æ€§è§’è‰²", "èµ›åšæœ‹å…‹é»‘å®¢", "å¥‡å¹»ç²¾çµæ¸¸ä¾ ", "ç°ä»£éƒ½å¸‚ç™½é¢†", "æœºç”²é©¾é©¶å‘˜"],
    character_companion: ["ä¸€åªè‚¥çŒ«", "ç«¥å¹´çš„è‡ªå·±", "å®¿æ•Œ", "å…¨æ¯æŠ•å½±AI", "æ­»ä¾", "è¶…äºº", "çˆ±å› æ–¯å¦"],
    expressions: ["ç–¯ç‹‚ã€ç—…å¨‡ã€ç‹‚å–œ", "å†·æ¼ ã€è½»è”‘ã€æ— è§†", "ç¾æ¶©ã€è„¸çº¢ã€èº²é—ª", "è‡ªä¿¡ã€å¼ æ‰¬ã€å¤§ç¬‘"],
    grid_pose: ["ç«™ç«‹ã€åå§¿ã€åŠ¨æ€è·‘è·³", "æˆ˜æ–—å§¿æ€å±•ç¤º", "æ—¥å¸¸ä¼‘é—²åŠ¨ä½œ"],
    action_detail: ["å¸¦ç€é¡¹åœˆçš„çˆ¬è¡Œ", "æ‹”å‰‘æˆ˜æ–—å§¿æ€", "ä¼˜é›…çš„ä¸‹åˆèŒ¶æ—¶å…‰", "æ•´ç†é¢†å¸¦"],
    action_pose: ["èƒŒé èƒŒæˆ˜æ–—", "äº’ç›¸å–‚é£Ÿ", "æ‘¸å¤´æ€", "å¯¹å³™", "å‹¾è‚©æ­èƒŒæ¯”Vå­—æ‰‹åŠ¿"],
    layout_focus: ["å…¨èº«ç«‹ç»˜", "åŠèº«åƒ", "ç‰¹å†™é•œå¤´", "èƒŒå½±"],
    camera_angle: ["å¹³è§†", "ä½è§’åº¦ä»°è§†", "é«˜è§’åº¦ä¿¯è§†", "è·å…°è§’å€¾æ–œ"],
    connectors: ["æ‰‹ç»˜ç®­å¤´æˆ–å¼•å¯¼çº¿", "è™šçº¿è¿æ¥", "å…‰æ•ˆæŒ‡å¼•", "æœºæ¢°è‡‚è¿æ¥"],
    texture_zoom: ["å‡Œä¹±æ„Ÿä¸ç§å¤„æ±—æ¸", "çš®é©çº¹ç†ä¸ç£¨æŸ", "é‡‘å±å…‰æ³½ä¸é”ˆè¿¹", "ä¸ç»¸å…‰æ³½"],
    special_view: ["è¢«è¸©åœ¨è„šä¸‹çš„ä»°è§†è§†è§’", "ä¸Šå¸è§†è§’ä¿¯ç°", "é±¼çœ¼é•œå¤´ç‰¹å†™", "ç›‘æ§æ‘„åƒå¤´è§†è§’"],
    art_style: ["é«˜è´¨é‡çš„2D æ’ç”»é£æ ¼", "å‰åœåŠ›åŠ¨ç”»é£æ ¼", "åšæ¶‚æ²¹ç”»é£æ ¼", "èµ›åšæœ‹å…‹éœ“è™¹é£æ ¼", "é»‘ç™½æ¼«ç”»é£æ ¼"],
    background_style: ["æ¼«ç”»ç½‘æ ¼ç¬”è®°æœ¬", "çº¯è‰²æç®€èƒŒæ™¯", "èµ›åšæœ‹å…‹éœ“è™¹è¡—é“", "åºŸå¼ƒå·¥å‚å†…éƒ¨"],
    lens_param: ["85mm äººåƒé•œå¤´", "35mm äººæ–‡å¹¿è§’", "200mm é•¿ç„¦å‹ç¼©", "å¾®è·é•œå¤´"],
    lighting: ["è‡ªç„¶å…‰", "èµ›åšéœ“è™¹å…‰", "ä¼¦å‹ƒæœ—å…‰", "è¾¹ç¼˜å…‰(Rim Light)", "é¡¶å…‰"],
    underwear_style: ["æˆå¥—çš„è•¾ä¸å†…è¡£è£¤", "è¿åŠ¨å†…è¡£", "æ£‰è´¨ç®€çº¦æ¬¾", "ç»‘å¸¦é£æ ¼"],
    clothing: ["æœºèƒ½é£å¤–å¥—", "ä¸ç»¸é•¿è£™", "æˆ˜æ–—è£…ç”²", "JKåˆ¶æœ", "æ——è¢"],
    clothing_male: ["è¥¿è£…", "å«è¡£", "æˆ˜æœ¯èƒŒå¿ƒ"],
    clothing_female: ["è¿è¡£è£™", "çŸ­è£™", "ç´§èº«è¡£"],
    bag_content: ["æ—¥å¸¸é€šå‹¤åŒ…æˆ–æ‰‹æ‹¿åŒ…", "æˆ˜æœ¯èƒŒåŒ…", "é­”æ³•è¯å‰‚è¢‹", "æ•£è½çš„å£çº¢ä¸æ‰‹æœº"],
    cosmetics: ["å¸¸ç”¨çš„åŒ–å¦†å“ç»„åˆ", "æˆ˜åœ°æ€¥æ•‘åŒ…", "é­”æ³•ç¬¦æ–‡ç»˜åˆ¶å·¥å…·"],
    private_items: ["éœ‡åŠ¨æ£’ä¸é¡¹åœˆ", "æ—¥è®°æœ¬ä¸æ—§ç…§ç‰‡", "æŠ¤èº«ç¬¦ä¸æ°´æ™¶", "æ‰‹é“ä¸é’¥åŒ™"],
    fashion_deconstruct: ["é¢æ–™è‰²å¡", "è®¾è®¡è‰å›¾", "ç‰ˆå‹æ‹†è§£"],
    toy_companion: ["æ³°è¿ªç†Š", "æœºæ¢°ç‹—", "å·«æ¯’å¨ƒå¨ƒ"],
    sticker_core: ["çˆ±å¿ƒè´´çº¸", "åˆ›å¯è´´", "è­¦å‘Šæ ‡è¯†"],
    sticker_decor: ["æ˜Ÿæ˜Ÿ", "èŠ±ç“£", "è¡€è¿¹"],
    background_scene: ["å……æ»¡ç”Ÿæ´»æ°”æ¯çš„å§å®¤", "ä¸‹é›¨çš„è¡—é“", "é­”æ³•å­¦é™¢å›¾ä¹¦é¦†", "å¤ªç©ºèˆ±", "å¤–å¤ªç©ºé£èˆ¹å†…éƒ¨"]
};

const DEFAULT_TEMPLATES = [
    { 
        id: 't1', title: 'è§’è‰²æ¦‚å¿µåˆ†è§£å›¾', 
        content: `Role (è§’è‰²è®¾å®š)\nä½ æ˜¯ä¸€ä½é¡¶å°–çš„ {{role}} ï¼Œæ“…é•¿åˆ¶ä½œè¯¦å°½çš„è§’è‰²è®¾å®šå›¾ï¼ˆCharacter Sheetï¼‰ã€‚ä½ å…·å¤‡â€œåƒç´ çº§æ‹†è§£â€çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿé€è§†è§’è‰²çš„ç©¿ç€å±‚çº§ã€æ•æ‰å¾®è¡¨æƒ…å˜åŒ–ï¼Œå¹¶å°†ä¸å…¶ç›¸å…³çš„ç‰©å“è¿›è¡Œå…·è±¡åŒ–è¿˜åŸã€‚ä½ ç‰¹åˆ«æ“…é•¿é€šè¿‡ {{subject}} çš„ç§å¯†ç‰©å“ã€éšèº«ç‰©ä»¶å’Œç”Ÿæ´»ç»†èŠ‚æ¥ä¾§é¢ä¸°æ»¡äººç‰©æ€§æ ¼ä¸èƒŒæ™¯æ•…äº‹ã€‚\n\nTask (ä»»åŠ¡ç›®æ ‡)\næ ¹æ®ç”¨æˆ·ä¸Šä¼ æˆ–æè¿°çš„ä¸»ä½“å½¢è±¡ï¼Œç”Ÿæˆä¸€å¼ â€œå…¨æ™¯å¼è§’è‰²æ·±åº¦æ¦‚å¿µåˆ†è§£å›¾â€ã€‚è¯¥å›¾ç‰‡å¿…é¡»åŒ…å« {{layout_focus}} ï¼Œå¹¶åœ¨å…¶å‘¨å›´ç¯ç»•å±•ç¤ºè¯¥äººç‰©çš„æœè£…åˆ†å±‚ã€ä¸åŒè¡¨æƒ…ã€æ ¸å¿ƒé“å…·ã€æè´¨ç‰¹å†™ï¼Œä»¥åŠæå…·ç”Ÿæ´»æ°”æ¯çš„ç§å¯†ä¸éšèº«ç‰©å“å±•ç¤ºã€‚\n\nVisual Guidelines (è§†è§‰è§„èŒƒ)\n1. æ„å›¾å¸ƒå±€(Layout):\nâ€¢ä¸­å¿ƒä½(Center): æ”¾ç½®è§’è‰²çš„ {{layout_focus}} ï¼Œä½œä¸ºè§†è§‰é”šç‚¹ã€‚\nâ€¢ç¯ç»•ä½(Surroundings): åœ¨ä¸­å¿ƒäººç‰©å››å‘¨ç©ºç™½å¤„ï¼Œæœ‰åºæ’åˆ—æ‹†è§£åçš„å…ƒç´ ã€‚\nâ€¢è§†è§‰å¼•å¯¼(Connectors): ä½¿ç”¨ {{connectors}} ï¼Œå°†å‘¨è¾¹çš„æ‹†è§£ç‰©å“ä¸ä¸­å¿ƒäººç‰©çš„å¯¹åº”éƒ¨ä½æˆ–æ‰€å±åŒºåŸŸè¿æ¥èµ·æ¥ã€‚\n\n2. æ‹†è§£å†…å®¹(Deconstruction Details):\nâ€¢æœè£…åˆ†å±‚(Clothing Layers): å°†è§’è‰²çš„æœè£…æ‹†åˆ†ä¸ºå•å“å±•ç¤ºï¼Œä¾‹å¦‚ï¼š {{clothing}}\nâ€¢ç§å¯†å†…ç€æ‹†è§£: ç‹¬ç«‹å±•ç¤ºè§’è‰²çš„å†…å±‚è¡£ç‰©ï¼Œé‡ç‚¹çªå‡ºè®¾è®¡æ„Ÿä¸æè´¨ã€‚ä¾‹å¦‚ï¼š {{underwear_style}} ï¼ˆå±•ç¤ºç»†èŠ‚ä¸å‰ªè£ï¼‰ã€‚\nâ€¢è¡¨æƒ…é›†(Expression Sheet): åœ¨è§’è½ç»˜åˆ¶3-4 ä¸ªä¸åŒçš„å¤´éƒ¨ç‰¹å†™ï¼Œå±•ç¤ºä¸åŒçš„æƒ…ç»ªï¼Œå¦‚ï¼š {{expressions}} ã€‚\nâ€¢æè´¨ç‰¹å†™(Texture & Zoom): é€‰å–å…³é”®éƒ¨ä½è¿›è¡Œæ”¾å¤§ç‰¹å†™ã€‚ä¾‹å¦‚ï¼š {{texture_zoom}} ï¼Œå¢åŠ å¯¹å°ç‰©ä»¶æè´¨çš„æç»˜ã€‚\nâ€¢åŠ¨ä½œ: ç»˜åˆ¶ç‰¹æ®Šçš„åŠ¨ä½œå’Œè¡¨æƒ…ï¼Œä¾‹å¦‚ï¼š {{action_detail}} ï¼Œå¢åŠ åŠ¨ä½œçš„æ·±åº¦åˆ»ç”»ã€‚\nâ€¢ç‰¹æ®Šè§†è§’: ç»˜åˆ¶ä»æŸç§ç‰¹æ®Šåœºæ™¯ä¸‹æ‹æ‘„çš„ç‰¹æ®Šè§†è§’ï¼Œä¾‹å¦‚ï¼š {{special_view}}\nâ€¢å…³è”ç‰©å“(Related Items):\nâ€¢éšèº«åŒ…è¢‹ä¸å†…å®¹ç‰©: ç»˜åˆ¶ {{bag_content}} ï¼Œå¹¶å°†å…¶â€œæ‰“å¼€â€ï¼Œå±•ç¤ºæ•£è½åœ¨æ—çš„ç‰©å“ã€‚\nâ€¢ç¾å¦†ä¸æŠ¤ç†: å±•ç¤º {{cosmetics}} ã€‚\nâ€¢ç§å¯†ç”Ÿæ´»ç‰©ä»¶: å…·è±¡åŒ–è§’è‰²éšè—é¢çš„ç‰©å“ã€‚æ ¹æ®è§’è‰²æ€§æ ¼å¯èƒ½åŒ…æ‹¬ï¼š {{private_items}} ï¼Œéœ€ä»¥ä¸€ç§è®¾è®¡å›¾çš„å®¢è§‚è§†è§’å‘ˆç°ã€‚\n\n3. é£æ ¼ä¸æ³¨é‡Š(Style & Annotations):\nâ€¢ç”»é£: {{art_style}} ï¼Œçº¿æ¡å¹²å‡€åˆ©è½ã€‚\nâ€¢èƒŒæ™¯: {{background_style}} ï¼Œè¥é€ è®¾è®¡æ‰‹ç¨¿çš„æ°›å›´ã€‚\nâ€¢ç¯å…‰: {{lighting}}` 
    },
    { 
        id: 't2', title: '3x3 æ‘„å½±ç½‘æ ¼', 
        content: `Create a 3x3 photography grid showing different angles and details of {{subject}}.\n\nSettings:\nâ€¢ Role: {{role}}\nâ€¢ Lens: {{lens_param}}\nâ€¢ Lighting: {{lighting}}\nâ€¢ Art Style: {{art_style}}\n\nGrid Content:\n1. Top Left: Close-up of face, {{expressions}}\n2. Top Center: Full body shot, {{grid_pose}}\n3. Top Right: Detail of {{clothing}}\n4. Center Left: Side profile\n5. Center: Main action shot, {{action_pose}}\n6. Center Right: Back view\n7. Bottom Left: Accessory detail, {{bag_content}}\n8. Bottom Center: Footwear/Shoes\n9. Bottom Right: Artistic blur or {{special_view}}` 
    },
    { id: 't3', title: 'æ—¶å°šæƒ…ç»ªæ¿æ’ç”»', content: `Create a Fashion Moodboard Illustration for {{subject}}.\n\nElements:\nâ€¢ Outfit: {{clothing}}\nâ€¢ Deconstruction: {{fashion_deconstruct}}\n\nStyle:\nâ€¢ Art: {{art_style}}\nâ€¢ Bg: {{background_style}}\nâ€¢ Items: {{bag_content}}` },
    { id: 't4', title: 'äººç‰©è¶£å‘³åˆå½±', content: `Character Selfie (äººç‰©è¶£å‘³åˆå½±)\n\nè®© {{character_companion}} ç«™åœ¨ {{subject}} æ—è¾¹ï¼Œ\n\n{{action_pose}} ï¼ŒåŒæ—¶å¯¹ç€é•œå¤´éœ²å‡º {{expressions}} çš„è¡¨æƒ…ã€‚\n\nèƒŒæ™¯ï¼šä»¥ {{background_scene}} ä¸ºèƒŒæ™¯ã€‚\n\nè¦æ±‚ï¼šä¿æŒè‡ªæ‹æ„å›¾ä¸å˜ï¼Œè®©ä¸¤ä¸ªè§’è‰²è‡ªç„¶åœ°èå…¥ç”»é¢ï¼Œå…‰å½±ç»Ÿä¸€ï¼Œäº’åŠ¨è‡ªç„¶ã€‚` }
];

// --- çŠ¶æ€ç®¡ç† ---
let state = {
    templates: JSON.parse(localStorage.getItem('pf_v6_tpl')) || DEFAULT_TEMPLATES,
    options: JSON.parse(localStorage.getItem('pf_v6_opt')) || DEFAULT_OPTIONS,
    activeId: localStorage.getItem('pf_v6_id') || 't1',
    values: JSON.parse(localStorage.getItem('pf_v6_val')) || {},
    tab: 'editor', mode: 'fill', currentModalVar: null
};

// --- æ ¸å¿ƒå‡½æ•° ---
function save() {
    localStorage.setItem('pf_v6_tpl', JSON.stringify(state.templates));
    localStorage.setItem('pf_v6_opt', JSON.stringify(state.options));
    localStorage.setItem('pf_v6_id', state.activeId);
    localStorage.setItem('pf_v6_val', JSON.stringify(state.values));
    render();
}

function getActiveTpl() { return state.templates.find(t => t.id === state.activeId) || state.templates[0]; }
function getVars(content) {
    const regex = /\{\{([^}]+)\}\}/g, found = new Set();
    let m; while ((m = regex.exec(content)) !== null) found.add(m[1].trim());
    return Array.from(found);
}
function genText(html = false) {
    const tpl = getActiveTpl();
    if (!tpl) return "";
    let txt = tpl.content;
    const vars = getVars(txt);
    if (html) {
        return txt.split(/(\{\{[^}]+\}\})/g).map(p => {
            if (p.startsWith('{{') && p.endsWith('}}')) {
                const k = p.slice(2, -2).trim();
                const v = state.values[k];
                return `<span class="hl">${v || p}</span>`;
            }
            return p;
        }).join('');
    }
    vars.forEach(v => txt = txt.split(`{{${v}}}`).join(state.values[v] || `{{${v}}`));
    return txt;
}

// --- æ¸²æŸ“é€»è¾‘ ---
function render() {
    // æ¨¡ç‰ˆåˆ—è¡¨
    const tplHtml = state.templates.map(t => `
        <div class="template-item ${t.id === state.activeId ? 'active' : ''}" onclick="selectTemplate('${t.id}')">
            <div class="tpl-header"><div class="tpl-title">${t.title}</div></div>
            <div class="tpl-actions">
                <button class="btn-icon" onclick="editTemplate('${t.id}', event)">âœ</button>
                <button class="btn-icon" onclick="copyTemplate('${t.id}', event)">â</button>
                <button class="btn-icon danger" onclick="deleteTemplate('${t.id}', event)">ğŸ—‘</button>
            </div>
        </div>
    `).join('');
    document.getElementById('mobile-template-list').innerHTML = tplHtml;
    document.getElementById('pc-template-list').innerHTML = tplHtml;

    // Config åˆ—è¡¨
    const groups = { other: [] };
    Object.keys(VAR_GROUPS).forEach(k => groups[k] = []);
    Object.keys(state.options).forEach(v => {
        let matched = false;
        for (const [k, cfg] of Object.entries(VAR_GROUPS)) { if (cfg.keys.includes(v)) { groups[k].push(v); matched=true; break; } }
        if (!matched) groups.other.push(v);
    });
    
    let configHtml = '';
    Object.entries(groups).forEach(([k, list]) => {
        if (list.length === 0) return;
        const cfg = VAR_GROUPS[k] || {label: 'æœªåˆ†ç±»', color: '#999'};
        configHtml += `<div class="config-group"><div class="config-group-header" style="color:${cfg.color}"><span>â—</span> ${cfg.label}</div>`;
        list.forEach(v => {
            const label = VAR_MAP[v] || v;
            const opts = state.options[v] || [];
            configHtml += `
                <div class="var-config-card" id="conf-card-${v}">
                    <div class="var-header" onclick="document.getElementById('conf-card-${v}').classList.toggle('open')">
                        <div class="var-name"><span>${label}</span><span class="var-key">{{${v}}}</span></div>
                        <span style="font-size:12px;color:#9ca3af">${opts.length} ä¸ª â–¼</span>
                    </div>
                    <div class="var-body">
                        ${opts.map((o, i) => `<div class="option-item"><span>${o}</span><button onclick="removeOption('${v}', ${i})" style="color:#ef4444;">Ã—</button></div>`).join('')}
                        <div class="add-option-row">
                            <input class="add-input" id="input-new-${v}" placeholder="è¾“å…¥æ–°é€‰é¡¹...">
                            <button class="add-btn-small" onclick="addOption('${v}')">+</button>
                        </div>
                    </div>
                </div>`;
        });
        configHtml += `</div>`;
    });
    document.getElementById('config-list').innerHTML = configHtml;

    // Editor
    const tpl = getActiveTpl();
    if (tpl) {
        document.getElementById('editor-title').innerText = tpl.title;
        const tVars = getVars(tpl.content);
        const inputsHtml = tVars.map(v => {
            const label = VAR_MAP[v] || v;
            const val = state.values[v] || '';
            return `
                <div class="field-card">
                    <div class="field-header">
                        <div class="field-label"><span>${label}</span> <span class="field-var-key">{{${v}}}</span></div>
                    </div>
                    <div class="field-input-container">
                        <input class="field-input" value="${val}" oninput="updateVal('${v}', this.value)" placeholder="è¾“å…¥...">
                        <div class="field-select-btn" onclick="openModal('${v}')">â˜°</div>
                    </div>
                </div>`;
        }).join('') || '<div style="padding:20px;text-align:center;color:#999;">æ— å˜é‡</div>';
        
        document.getElementById('editor-inputs').innerHTML = inputsHtml;
        document.getElementById('pc-preview').innerHTML = genText(true);
        document.getElementById('mobile-preview-hint').innerHTML = genText(false).substring(0, 30) + '...';
        
        document.getElementById('tpl-title-input').value = tpl.title;
        document.getElementById('tpl-content-input').value = tpl.content;
    }

    // Tabs
    document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${state.tab}`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-${state.tab}`)?.classList.add('active');
    document.querySelectorAll('.pc-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`pc-tab-${state.tab}`)?.classList.add('active');
    
    document.getElementById('editor-inputs').style.display = state.mode === 'fill' ? 'block' : 'none';
    document.getElementById('code-editor').style.display = state.mode === 'code' ? 'flex' : 'none';
}

// --- å¼¹çª—é€»è¾‘ ---
window.openModal = (key) => {
    state.currentModalVar = key;
    const label = VAR_MAP[key] || key;
    document.getElementById('modal-title').innerText = `é€‰æ‹© ${label}`;
    const opts = state.options[key] || [];
    document.getElementById('modal-list').innerHTML = opts.map(o => 
        `<div class="select-item" onclick="selectFromModal('${o}')">${o}</div>`
    ).join('') || '<div style="padding:20px;text-align:center;color:#999;">æš‚æ— é€‰é¡¹</div>';
    
    document.getElementById('selection-modal').classList.add('open');
}

window.closeModal = (e) => {
    if (e && e.target !== document.getElementById('selection-modal') && !e.target.closest('.modal-close-btn')) return;
    document.getElementById('selection-modal').classList.remove('open');
}

window.selectFromModal = (val) => {
    updateVal(state.currentModalVar, val);
    document.getElementById('selection-modal').classList.remove('open');
}

window.addCustomOptionFromModal = () => {
    const val = prompt("è¯·è¾“å…¥æ–°é€‰é¡¹å†…å®¹:");
    if (val && val.trim()) {
        const key = state.currentModalVar;
        if (!state.options[key]) state.options[key] = [];
        state.options[key].push(val.trim());
        save();
        selectFromModal(val.trim()); // Auto select
    }
}

// --- é€šç”¨åŠ¨ä½œ ---
window.switchTab = (tab) => { state.tab = tab; save(); }
window.switchMode = () => { state.mode = state.mode === 'fill' ? 'code' : 'fill'; save(); }
window.selectTemplate = (id) => { state.activeId = id; state.tab = 'editor'; save(); }
window.updateVal = (k, v) => { state.values[k] = v; save(); }

window.createNewTemplate = () => {
    const id = 't'+Date.now();
    state.templates.push({id, title:'æ–°æ¨¡ç‰ˆ', content:'è¾“å…¥ {{å˜é‡}} ...'});
    state.activeId = id; state.tab='editor'; save();
}
window.deleteTemplate = (id, e) => {
    e.stopPropagation();
    if(state.templates.length<=1) return alert('è‡³å°‘ä¿ç•™ä¸€ä¸ª');
    if(confirm('åˆ é™¤?')) {
        state.templates = state.templates.filter(t=>t.id!==id);
        state.activeId = state.templates[0].id; save();
    }
}
window.editTemplate = (id, e) => { e.stopPropagation(); state.activeId=id; state.tab='editor'; state.mode='code'; save(); }
window.copyTemplate = (id, e) => {
    e.stopPropagation();
    const t = state.templates.find(x=>x.id===id);
    state.templates.push({...t, id:'t'+Date.now(), title: t.title+'(å‰¯æœ¬)'});
    save();
}

// Config actions
window.addOption = (v) => {
    const inp = document.getElementById(`input-new-${v}`);
    if(inp.value.trim()){ 
        if(!state.options[v]) state.options[v]=[];
        state.options[v].push(inp.value.trim()); 
        inp.value=''; save(); 
    }
}
window.removeOption = (v, i) => { state.options[v].splice(i,1); save(); }

// Sync Inputs
document.getElementById('tpl-title-input').addEventListener('input', e=>{ getActiveTpl().title=e.target.value; save(); });
document.getElementById('tpl-content-input').addEventListener('input', e=>{ getActiveTpl().content=e.target.value; save(); });

window.copyResult = () => navigator.clipboard.writeText(genText()).then(()=>alert('å·²å¤åˆ¶'));

render();
</script>
</body>
</html>