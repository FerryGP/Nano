<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEO 监控看板 (自动化集成版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 font-sans text-gray-800 h-screen flex overflow-hidden">

    <!-- 侧边栏保持不变，省略部分代码以节省篇幅，重点在 Script 部分 -->
    <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-blue-700 flex items-center gap-2">
                <i class="ph ph-robot text-2xl"></i>
                GEO 自动看板
            </h1>
        </div>
        <nav class="p-4 flex-1 space-y-2">
            <button onclick="switchTab('dashboard')" class="nav-btn bg-blue-600 text-white w-full px-4 py-3 rounded-lg flex items-center gap-2">
                <i class="ph ph-squares-four"></i> 数据总览
            </button>
            <button onclick="switchTab('data')" class="nav-btn text-gray-600 hover:bg-gray-100 w-full px-4 py-3 rounded-lg flex items-center gap-2">
                <i class="ph ph-table"></i> 数据明细
            </button>
        </nav>
        
        <!-- 新增：CSV 导入区 -->
        <div class="p-4 border-t bg-blue-50">
            <label class="block text-xs font-bold text-blue-800 mb-2">导入 Python 脚本数据</label>
            <input type="file" id="csv-upload" accept=".csv" class="block w-full text-xs text-gray-500
              file:mr-2 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-xs file:font-semibold
              file:bg-blue-100 file:text-blue-700
              hover:file:bg-blue-200
            "/>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">
        <!-- Dashboard 内容区 -->
        <div id="tab-dashboard" class="tab-content block">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">实时诊断报告</h2>
                <div class="text-sm text-gray-500">数据来源: <span id="data-source-tag">默认样本</span></div>
            </header>

            <div class="grid grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-gray-500 text-sm">首位推荐率</h3>
                    <div class="text-3xl font-bold text-green-600" id="stat-visibility">0%</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-gray-500 text-sm">正面情感占比</h3>
                    <div class="text-3xl font-bold text-blue-600" id="stat-sentiment">0%</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-gray-500 text-sm">致命伤预警</h3>
                    <div class="text-3xl font-bold text-red-500" id="stat-negative">0</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6 h-80">
                <div class="bg-white p-4 rounded-xl shadow-sm border relative">
                    <canvas id="chart-visibility"></canvas>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border relative">
                    <canvas id="chart-ranking"></canvas>
                </div>
            </div>
        </div>

        <!-- 数据表格区 -->
        <div id="tab-data" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">详细数据</h2>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-3">平台</th>
                            <th class="p-3">可见性</th>
                            <th class="p-3">情感</th>
                            <th class="p-3">关键词</th>
                            <th class="p-3">致命伤</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        let reportData = [];
        let visChart = null;
        let rankChart = null;

        // 切换 Tab 逻辑
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
        }

        // CSV 导入逻辑 (PapaParse)
        document.getElementById('csv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    console.log("解析完成:", results.data);
                    // 简单的字段映射清洗
                    reportData = results.data.filter(row => row.platform).map(row => ({
                        platform: row.platform,
                        visibility: row.visibility || row['可见性'] || '未知',
                        sentiment: row.sentiment || row['情感倾向'] || '中立',
                        keywords: row.keywords || row['核心关键词'] || '',
                        negative: row.negative || row['致命伤'] || '无'
                    }));
                    
                    document.getElementById('data-source-tag').innerText = "Python 自动抓取 (" + file.name + ")";
                    updateUI();
                    alert(`成功导入 ${reportData.length} 条数据！`);
                }
            });
        });

        function updateUI() {
            // 更新统计
            const total = reportData.length;
            if (total === 0) return;
            
            const top1 = reportData.filter(d => d.visibility.includes('1')).length;
            const positive = reportData.filter(d => d.sentiment === '正面').length;
            const negatives = reportData.filter(d => d.negative !== '无' && d.negative !== '').length;

            document.getElementById('stat-visibility').innerText = Math.round(top1/total*100) + "%";
            document.getElementById('stat-sentiment').innerText = Math.round(positive/total*100) + "%";
            document.getElementById('stat-negative').innerText = negatives;

            // 更新表格
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = reportData.map(row => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium">${row.platform}</td>
                    <td class="p-3"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${row.visibility}</span></td>
                    <td class="p-3">${row.sentiment}</td>
                    <td class="p-3 text-gray-500 truncate max-w-xs">${row.keywords}</td>
                    <td class="p-3 text-red-500">${row.negative}</td>
                </tr>
            `).join('');

            // 更新图表
            updateCharts();
        }

        function updateCharts() {
            // 饼图数据
            const visCounts = {};
            reportData.forEach(d => visCounts[d.visibility] = (visCounts[d.visibility]||0)+1);
            
            const ctxPie = document.getElementById('chart-visibility').getContext('2d');
            if(visChart) visChart.destroy();
            visChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(visCounts),
                    datasets: [{ data: Object.values(visCounts), backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444'] }]
                }
            });

            // 柱状图数据 (简单计数)
            const platCounts = {};
            reportData.forEach(d => {
                if(d.visibility.includes('1') || d.visibility.includes('前3')) {
                    platCounts[d.platform] = (platCounts[d.platform]||0) + 1;
                }
            });

            const ctxBar = document.getElementById('chart-ranking').getContext('2d');
            if(rankChart) rankChart.destroy();
            rankChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: Object.keys(platCounts),
                    datasets: [{ label: '高质量推荐次数', data: Object.values(platCounts), backgroundColor: '#3b82f6' }]
                }
            });
        }
        
        // 初始化空状态
        updateUI();
    </script>
</body>
</html>